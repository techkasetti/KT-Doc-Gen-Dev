<template>
    <div class="slds-card slds-card_boundary">
        <!-- Enhanced Header with Better Visual Hierarchy -->
        <div class="slds-card__header slds-grid slds-grid_align-spread slds-p-around_medium">
            <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__figure">
                    <div class="slds-avatar slds-avatar_medium slds-avatar_circle" style="background: linear-gradient(45deg, #1589ee, #0176d3);">
                        <lightning-icon 
                            icon-name="standard:einstein" 
                            size="medium" 
                            variant="inverse">
                        </lightning-icon>
                    </div>
                </div>
                <div class="slds-media__body">
                    <h2 class="slds-card__header-title slds-text-heading_medium slds-text-color_default">
                        <span class="slds-text-title_caps">AI Model Configuration</span>
                    </h2>
                    <p class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                        Configure and manage available AI models for intelligent document generation
                    </p>
                </div>
            </header>
            <div class="slds-no-flex">
                <lightning-button-menu 
                    alternative-text="Model Actions" 
                    icon-name="utility:settings"
                    variant="border-filled"
                    menu-alignment="right">
                    <lightning-menu-item value="add" label="Add New Model"></lightning-menu-item>
                    <lightning-menu-item value="import" label="Import Configuration"></lightning-menu-item>
                    <lightning-menu-item value="export" label="Export Configuration"></lightning-menu-item>
                </lightning-button-menu>
            </div>
        </div>
        
        <div class="slds-card__body slds-card__body_inner slds-p-horizontal_large slds-p-vertical_medium">
            <!-- Enhanced Models Table with Better Spacing -->
            <div class="slds-box slds-box_xx-small slds-theme_shade slds-m-bottom_large">
                <div class="slds-grid slds-grid_align-spread slds-p-around_small">
                    <div class="slds-text-heading_small slds-text-color_default">
                        Available AI Models
                    </div>
                    <div class="slds-text-body_small slds-text-color_weak">
                        {aiModels.length} {modelCountText} configured
                    </div>
                </div>
            </div>
            
            <div class="slds-scrollable_x">
                <lightning-datatable
                    key-field="id"
                    data={aiModels}
                    columns={columns}
                    onrowaction={handleRowAction}
                    hide-checkbox-column="true"
                    show-row-number-column="false"
                    resize-column-disabled="false"
                    sorted-by={sortedBy}
                    sorted-direction={sortedDirection}
                    onsort={handleSort}>
                </lightning-datatable>
            </div>
            
            <!-- Enhanced Model Testing Section -->
            <template if:true={showTestSection}>
                <div class="slds-section slds-is-open slds-m-top_x-large">
                    <div class="slds-section__title-action-container">
                        <h3 class="slds-section__title slds-text-heading_small">
                            <lightning-icon 
                                icon-name="utility:test" 
                                size="x-small" 
                                class="slds-m-right_x-small">
                            </lightning-icon>
                            <span class="slds-truncate">Model Connection Testing</span>
                        </h3>
                    </div>
                    
                    <div class="slds-section__content slds-p-top_medium">
                        <!-- Test Configuration Card -->
                        <div class="slds-box slds-box_x-small slds-theme_default slds-m-bottom_medium">
                            <div class="slds-grid slds-gutters slds-grid_vertical-align-end">
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-combobox
                                        name="testModel"
                                        label="Select Model to Test"
                                        value={selectedTestModel}
                                        placeholder="Choose an AI model..."
                                        options={modelTestOptions}
                                        onchange={handleTestModelSelection}
                                        field-level-help="Select a configured AI model to test its connection and response capabilities"
                                        required="true">
                                    </lightning-combobox>
                                </div>
                                
                                <div class="slds-col slds-size_1-of-4">
                                    <lightning-input
                                        type="text"
                                        label="Test Prompt"
                                        value={testPrompt}
                                        placeholder="Hello, world!"
                                        onchange={handleTestPromptChange}
                                        field-level-help="Enter a test message to send to the model">
                                    </lightning-input>
                                </div>
                                
                                <div class="slds-col slds-size_1-of-4">
                                    <lightning-button
                                        variant="brand"
                                        label="Run Test"
                                        icon-name="utility:play"
                                        onclick={handleTestConnection}
                                        disabled={testButtonDisabled}
                                        class="slds-m-left_small">
                                    </lightning-button>
                                    
                                    <template if:true={isTestRunning}>
                                        <lightning-spinner 
                                            alternative-text="Testing connection..." 
                                            size="small"
                                            class="slds-m-left_small">
                                        </lightning-spinner>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Test Results with Better Visual Feedback -->
                        <template if:true={testResult}>
                            <div class="slds-m-top_medium">
                                <div class={testResultClass}>
                                    <div class="slds-grid slds-grid_vertical-align-start">
                                        <div class="slds-col slds-no-flex slds-m-right_small">
                                            <lightning-icon 
                                                icon-name={testResultIcon} 
                                                size="small" 
                                                variant={testResultIconVariant}>
                                            </lightning-icon>
                                        </div>
                                        <div class="slds-col slds-has-flexi-truncate">
                                            <h4 class="slds-text-heading_x-small slds-m-bottom_xx-small">
                                                {testResultTitle}
                                            </h4>
                                            <p class="slds-text-body_regular">
                                                {testResult}
                                            </p>
                                            
                                            <!-- Test Metrics -->
                                            <template if:true={testMetrics}>
                                                <div class="slds-grid slds-gutters_small slds-m-top_small">
                                                    <div class="slds-col">
                                                        <div class="slds-text-body_small slds-text-color_weak">
                                                            Response Time: <strong>{testMetrics.responseTime}ms</strong>
                                                        </div>
                                                    </div>
                                                    <div class="slds-col">
                                                        <div class="slds-text-body_small slds-text-color_weak">
                                                            Status: <strong>{testMetrics.status}</strong>
                                                        </div>
                                                    </div>
                                                    <div class="slds-col">
                                                        <div class="slds-text-body_small slds-text-color_weak">
                                                            Model Version: <strong>{testMetrics.version}</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Test History (Optional Enhancement) -->
                        <template if:true={showTestHistory}>
                            <div class="slds-m-top_large">
                                <h4 class="slds-text-heading_x-small slds-m-bottom_small slds-text-color_weak">
                                    Recent Test History
                                </h4>
                                <div class="slds-scrollable_y" style="max-height: 200px;">
                                    <template for:each={testHistory} for:item="test">
                                        <div key={test.id} class="slds-box slds-box_xx-small slds-m-bottom_xx-small">
                                            <div class="slds-grid slds-grid_align-spread">
                                                <div class="slds-text-body_small">
                                                    {test.modelName} - {test.timestamp}
                                                </div>
                                                <div class={test.statusClass}>
                                                    {test.status}
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
            
            <!-- Help Section -->
            <template if:true={showHelp}>
                <div class="slds-box slds-box_x-small slds-theme_info slds-m-top_large">
                    <div class="slds-grid slds-grid_vertical-align-start">
                        <div class="slds-col slds-no-flex slds-m-right_small">
                            <lightning-icon 
                                icon-name="utility:info" 
                                size="small" 
                                variant="inverse">
                            </lightning-icon>
                        </div>
                        <div class="slds-col">
                            <h4 class="slds-text-heading_x-small slds-m-bottom_xx-small">
                                Configuration Tips
                            </h4>
                            <ul class="slds-list_dotted slds-text-body_small">
                                <li>Ensure API keys are valid and have proper permissions</li>
                                <li>Test connections regularly to monitor model availability</li>
                                <li>Configure rate limits to prevent quota exhaustion</li>
                                <li>Use descriptive names for easy model identification</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Enhanced Footer -->
        <footer class="slds-card__footer slds-p-around_medium slds-theme_shade">
            <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                <div class="slds-text-body_small slds-text-color_weak">
                    Last updated: {lastUpdated}
                </div>
                <div class="slds-button-group" role="group">
                    <lightning-button 
                        variant="neutral" 
                        label="Refresh Models"
                        icon-name="utility:refresh"
                        onclick={handleRefreshModels}>
                    </lightning-button>
                    <lightning-button 
                        variant="brand-outline" 
                        label="Add New Model"
                        icon-name="utility:add"
                        onclick={handleAddModel}>
                    </lightning-button>
                </div>
            </div>
        </footer>
    </div>
</template>